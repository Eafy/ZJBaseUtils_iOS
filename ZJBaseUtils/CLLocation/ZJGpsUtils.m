//
//  ZJGpsUtils.m
//  ZJBaseUtils
//
//  Created by eafy on 2023/4/26.
//  Copyright © 2023 ZJ. All rights reserved.
//

#import "ZJGpsUtils.h"

NSString *const kMapCoordTypeBD09ll = @"bd09ll";
NSString *const kMapCoordTypeGCJ02 = @"gcj02";
NSString *const kMapCoordTypeWGS84 = @"wgs84";

@interface ZJGpsUtils ()

@property (nonatomic,strong) NSArray *regionOfChinaArray;

/// 已检测的状态
@property (nonatomic,assign) BOOL checkStatus;
/// 已检测次数
@property (nonatomic,assign) NSInteger checkCount;
/// 关闭检测状态
@property (nonatomic,assign) BOOL isCloseCheckStatus;

@end

@implementation ZJGpsUtils
singleton_m()

- (void)initData {
    
}

#pragma mark -

- (NSArray *)regionOfChinaArray {
    if (_regionOfChinaArray) return _regionOfChinaArray;
    NSMutableArray *list = [NSMutableArray array];
    [list addObject:@[  //大陆陆地区域
        @[@27.32083, @88.91693], @[@27.54243,  @88.76464], @[@28.00805, @88.83575], @[@28.1168,  @88.62435], @[@27.86605, @88.14279],
        @[@27.82305, @87.19275], @[@28.11166, @86.69527], @[@27.90888, @86.45137], @[@28.15805, @86.19769], @[@27.88625, @86.0054],
        @[@28.27916, @85.72137], @[@28.30666, @85.11095], @[@28.59104, @85.19518], @[@28.54444, @84.84665], @[@28.73402, @84.48623],
        @[@29.26097, @84.11651], @[@29.18902, @83.5479], @[@29.63166, @83.19109], @[@30.06923, @82.17525], @[@30.33444, @82.11123],
        @[@30.385, @81.42623], @[@30.01194, @81.23221], @[@30.20435, @81.02536], @[@30.57552, @80.207], @[@30.73374, @80.25423],
        @[@30.96583, @79.86304], @[@30.95708, @79.55429], @[@31.43729, @79.08082], @[@31.30895, @78.76825], @[@31.96847, @78.77075],
        @[@32.24304, @78.47594], @[@32.5561,  @78.40595], @[@32.63902, @78.74623], @[@32.35083, @78.9711], @[@32.75666, @79.52874],
        @[@33.09944, @79.37511], @[@33.42863, @78.93623], @[@33.52041, @78.81387], @[@34.06833, @78.73581], @[@34.35001, @78.98535],
        @[@34.6118, @78.33707], @[@35.28069, @78.02305], @[@35.49902, @78.0718], @[@35.50133, @77.82393], @[@35.6125, @76.89526],
        @[@35.90665, @76.55304], @[@35.81458, @76.18061], @[@36.07082, @75.92887], @[@36.23751, @76.04166], @[@36.66343, @75.85984],
        @[@36.73169, @75.45179], @[@36.91156, @75.39902], @[@36.99719, @75.14787], @[@37.02782, @74.56543], @[@37.17, @74.39089],
        @[@37.23733, @74.91574], @[@37.40659, @75.18748], @[@37.65243, @74.9036], @[@38.47256, @74.85442], @[@38.67438, @74.35471],
        @[@38.61271, @73.81401], @[@38.88653, @73.70818], @[@38.97256, @73.85235], @[@39.23569, @73.62005], @[@39.45483, @73.65569],
        @[@39.59965, @73.95471], @[@39.76896, @73.8429], @[@40.04202, @73.99096], @[@40.32792, @74.88089], @[@40.51723, @74.8588],
        @[@40.45042, @75.23394], @[@40.64452, @75.58284], @[@40.298, @75.70374], @[@40.35324, @76.3344], @[@41.01258, @76.87067],
        @[@41.04079, @78.08083], @[@41.39286, @78.39554], @[@42.03954, @80.24513], @[@42.19622, @80.23402], @[@42.63245, @80.15804],
        @[@42.81565, @80.25796], @[@42.88545, @80.57226], @[@43.02906, @80.38405], @[@43.1683, @80.81526], @[@44.11378, @80.36887],
        @[@44.6358, @80.38499], @[@44.73408, @80.51589], @[@44.90282, @79.87106], @[@45.3497, @81.67928], @[@45.15748, @81.94803],
        @[@45.13303, @82.56638], @[@45.43581, @82.64624], @[@45.5831, @82.32179], @[@47.20061, @83.03443], @[@46.97332, @83.93026],
        @[@46.99361, @84.67804], @[@46.8277, @84.80318], @[@47.0591, @85.52257], @[@47.26221, @85.70139], @[@47.93721, @85.53707],
        @[@48.39333, @85.76596], @[@48.54277, @86.59791], @[@49.1102, @86.87602], @[@49.09262, @87.34821], @[@49.17295, @87.8407],
        @[@48.98304, @87.89291], @[@48.88103, @87.7611], @[@48.73499, @88.05942], @[@48.56541, @87.99194], @[@48.40582, @88.51679],
        @[@48.21193, @88.61179], @[@47.99374, @89.08514], @[@47.88791, @90.07096], @[@46.95221, @90.9136], @[@46.57735, @91.07027],
        @[@46.29694, @90.92151], @[@46.01735, @91.02651], @[@45.57972, @90.68193], @[@45.25305, @90.89694], @[@45.07729, @91.56088],
        @[@44.95721, @93.5547], @[@44.35499, @94.71735], @[@44.29416, @95.41061], @[@44.01937, @95.34109], @[@43.99311, @95.53339],
        @[@43.28388, @95.87901], @[@42.73499, @96.38206], @[@42.79583, @97.1654], @[@42.57194, @99.51012], @[@42.67707, @100.8425],
        @[@42.50972, @101.8147], @[@42.23333, @102.0772], @[@41.88721, @103.4164], @[@41.87721, @104.5267], @[@41.67068, @104.5237],
        @[@41.58666, @105.0065], @[@42.46624, @107.4758], @[@42.42999, @109.3107], @[@42.64576, @110.1064], @[@43.31694, @110.9897],
        @[@43.69221, @111.9583], @[@44.37527, @111.4214], @[@45.04944, @111.873], @[@45.08055, @112.4272], @[@44.8461, @112.853],
        @[@44.74527, @113.638], @[@45.38943, @114.5453], @[@45.4586, @115.7019], @[@45.72193, @116.2104], @[@46.29583, @116.5855],
        @[@46.41888, @117.3755], @[@46.57069, @117.425], @[@46.53645, @117.8455], @[@46.73638, @118.3147], @[@46.59895, @119.7068],
        @[@46.71513, @119.9315], @[@46.90221, @119.9225], @[@47.66499, @119.125], @[@47.99475, @118.5393], @[@48.01125, @117.8046],
        @[@47.65741, @117.3827], @[@47.88805, @116.8747], @[@47.87819, @116.2624], @[@47.69186, @115.9231], @[@47.91749, @115.5944],
        @[@48.14353, @115.5491], @[@48.25249, @115.8358], @[@48.52055, @115.8111], @[@49.83047, @116.7114], @[@49.52058, @117.8747],
        @[@49.92263, @118.5746], @[@50.09631, @119.321], @[@50.33028, @119.36], @[@50.39027, @119.1386], @[@51.62083, @120.0641],
        @[@52.115, @120.7767], @[@52.34423, @120.6259], @[@52.54267, @120.7122], @[@52.58805, @120.0819], @[@52.76819, @120.0314],
        @[@53.26374, @120.8307], @[@53.54361, @123.6147], @[@53.18832, @124.4933], @[@53.05027, @125.62], @[@52.8752, @125.6573],
        @[@52.75722, @126.0968], @[@52.5761, @125.9943], @[@52.12694, @126.555], @[@51.99437, @126.4412], @[@51.38138, @126.9139],
        @[@51.26555, @126.8176], @[@51.31923, @126.9689], @[@51.05825, @126.9331], @[@50.74138, @127.2919], @[@50.31472, @127.334],
        @[@50.20856, @127.5861], @[@49.80588, @127.515], @[@49.58665, @127.838], @[@49.58443, @128.7119], @[@49.34676, @129.1118],
        @[@49.4158, @129.4902], @[@48.86464, @130.2246], @[@48.86041, @130.674], @[@48.60576, @130.5236], @[@48.3268, @130.824],
        @[@48.10839, @130.6598], @[@47.68721, @130.9922], @[@47.71027, @132.5211], @[@48.09888, @133.0827], @[@48.06888, @133.4843],
        @[@48.39112, @134.4153], @[@48.26713, @134.7408], @[@47.99207, @134.5576], @[@47.70027, @134.7608], @[@47.32333, @134.1825],
        @[@46.64017, @133.9977], @[@46.47888, @133.8472], @[@46.25363, @133.9016], @[@45.82347, @133.4761], @[@45.62458, @133.4702],
        @[@45.45083, @133.1491], @[@45.05694, @133.0253], @[@45.34582, @131.8684], @[@44.97388, @131.4691], @[@44.83649, @130.953],
        @[@44.05193, @131.298], @[@43.53624, @131.1912], @[@43.38958, @131.3104], @[@42.91645, @131.1285], @[@42.74485, @130.4327],
        @[@42.42186, @130.6044], @[@42.71416, @130.2468], @[@42.88794, @130.2514], @[@43.00457, @129.9046], @[@42.43582, @129.6955],
        @[@42.44624, @129.3493], @[@42.02736, @128.9269], @[@42.00124, @128.0566], @[@41.58284, @128.3002], @[@41.38124, @128.1529],
        @[@41.47249, @127.2708], @[@41.79222, @126.9047], @[@41.61176, @126.5661], @[@40.89694, @126.0118], @[@40.47037, @124.8851],
        @[@40.09362, @124.3736], @[@39.82777, @124.128], @[@39.8143, @123.2422], @[@39.67388, @123.2167], @[@38.99638, @121.648],
        @[@38.8611, @121.6982], @[@38.71909, @121.1873], @[@38.91221, @121.0887], @[@39.09013, @121.6794], @[@39.2186, @121.5994],
        @[@39.35166, @121.7511], @[@39.52847, @121.2283], @[@39.62322, @121.533], @[@39.81138, @121.4683], @[@40.00305, @121.881],
        @[@40.50562, @122.2987], @[@40.73874, @122.0521], @[@40.92194, @121.1775], @[@40.1961, @120.4468], @[@39.87242, @119.5264],
        @[@39.15693, @118.9715], @[@39.04083, @118.3273], @[@39.19846, @117.889], @[@38.67555, @117.5364], @[@38.38666, @117.6722],
        @[@38.16721, @118.0281], @[@38.1529, @118.8378], @[@37.87832, @119.0355], @[@37.30054, @118.9566], @[@37.14361, @119.2328],
        @[@37.15138, @119.7672], @[@37.35228, @119.8529], @[@37.83499, @120.7371], @[@37.42458, @121.58], @[@37.55256, @122.1282],
        @[@37.41833, @122.1814], @[@37.39624, @122.5586], @[@37.20999, @122.5972], @[@37.02583, @122.4005], @[@37.01978, @122.5392],
        @[@36.89361, @122.5047], @[@36.84298, @122.1923], @[@37.00027, @121.9566], @[@36.75889, @121.5944], @[@36.61666, @120.7764],
        @[@36.52638, @120.96], @[@36.37582, @120.8753], @[@36.42277, @120.7062], @[@36.14075, @120.6956], @[@36.0419, @120.3436],
        @[@36.26345, @120.3078], @[@36.19998, @120.0889], @[@35.95943, @120.2378], @[@35.57893, @119.6475], @[@34.88499, @119.1761],
        @[@34.31145, @120.2487], @[@32.97499, @120.8858], @[@32.63889, @120.8375], @[@32.42958, @121.3348], @[@32.11333, @121.4412],
        @[@32.02166, @121.7066], @[@31.67833, @121.8275], @[@31.86639, @120.9444], @[@32.09361, @120.6019], @[@31.94555, @120.099],
        @[@32.30638, @119.8267], @[@32.26277, @119.6317], @[@31.90388, @120.1364], @[@31.98833, @120.7026], @[@31.81944, @120.7196],
        @[@31.30889, @121.6681], @[@30.97986, @121.8828], @[@30.85305, @121.8469], @[@30.56889, @120.9915], @[@30.33555, @120.8144],
        @[@30.39298, @120.4586], @[@30.19694, @120.15], @[@30.31027, @120.5082], @[@30.06465, @120.7916], @[@30.30458, @121.2808],
        @[@29.96305, @121.6778], @[@29.88211, @122.1196], @[@29.51167, @121.4483], @[@29.58916, @121.9744], @[@29.19527, @121.9336],
        @[@29.18388, @121.8119], @[@29.37236, @121.7969], @[@29.19729, @121.7444], @[@29.29111, @121.5611], @[@29.1634, @121.4135],
        @[@29.02194, @121.6914], @[@28.9359, @121.4908], @[@28.72798, @121.6113], @[@28.84215, @121.1464], @[@28.66993, @121.4844],
        @[@28.34722, @121.6417], @[@28.13889, @121.3419], @[@28.38277, @121.1651], @[@27.98222, @120.9353], @[@28.07944, @120.5908],
        @[@27.87229, @120.84], @[@27.59319, @120.5812], @[@27.45083, @120.6655], @[@27.20777, @120.5075], @[@27.28278, @120.1896],
        @[@27.14764, @120.4211], @[@26.89805, @120.0332], @[@26.64465, @120.128], @[@26.51778, @119.8603], @[@26.78823, @120.0733],
        @[@26.64888, @119.8668], @[@26.79611, @119.7879], @[@26.75625, @119.5503], @[@26.44222, @119.8204], @[@26.47388, @119.5775],
        @[@26.33861, @119.658], @[@26.36777, @119.9489], @[@25.99694, @119.4253], @[@26.14041, @119.0975], @[@25.93788, @119.354],
        @[@25.99069, @119.7058], @[@25.67996, @119.5807], @[@25.68222, @119.4522], @[@25.35333, @119.6454], @[@25.60649, @119.3149],
        @[@25.42097, @119.1053], @[@25.25319, @119.3526], @[@25.17208, @119.2726], @[@25.2426, @118.8749], @[@24.97194, @118.9866],
        @[@24.88291, @118.5729], @[@24.75673, @118.7631], @[@24.52861, @118.5953], @[@24.53638, @118.2397], @[@24.68194, @118.1688],
        @[@24.44024, @118.0199], @[@24.46019, @117.7947], @[@24.25875, @118.1237], @[@23.62437, @117.1957], @[@23.65919, @116.9179],
        @[@23.355, @116.7603], @[@23.42024, @116.5322], @[@23.23666, @116.7871], @[@23.21083, @116.5139], @[@22.93902, @116.4817],
        @[@22.73916, @115.7978], @[@22.88416, @115.6403], @[@22.65889, @115.5367], @[@22.80833, @115.1614], @[@22.70277, @114.8889],
        @[@22.53305, @114.8722], @[@22.64027, @114.718], @[@22.81402, @114.7782], @[@22.69972, @114.5208], @[@22.50423, @114.6136],
        @[@22.55004, @114.2223], @[@22.42993, @114.3885], @[@22.26056, @114.2961], @[@22.36736, @113.9056], @[@22.50874, @114.0337],
        @[@22.47444, @113.8608], @[@22.83458, @113.606], @[@23.05027, @113.5253], @[@23.11724, @113.8219], @[@23.05083, @113.4793],
        @[@22.87986, @113.3629], @[@22.54944, @113.5648], @[@22.18701, @113.5527], @[@22.56701, @113.1687], @[@22.17965, @113.3868],
        @[@22.04069, @113.2226], @[@22.20485, @113.0848], @[@21.8693, @112.94], @[@21.96472, @112.824], @[@21.70139, @112.2819],
        @[@21.91611, @111.8921], @[@21.75139, @111.9669], @[@21.77819, @111.6762], @[@21.61264, @111.7832], @[@21.5268, @111.644],
        @[@21.52528, @111.0285], @[@21.21138, @110.5328], @[@21.37322, @110.3944], @[@20.84381, @110.1594], @[@20.84083, @110.3755],
        @[@20.64, @110.3239], @[@20.48618, @110.5274], @[@20.24611, @110.2789], @[@20.2336, @109.9244], @[@20.4318, @110.0069],
        @[@20.92416, @109.6629], @[@21.44694, @109.9411], @[@21.50569, @109.6605], @[@21.72333, @109.5733], @[@21.49499, @109.5344],
        @[@21.39666, @109.1428], @[@21.58305, @109.1375], @[@21.61611, @108.911], @[@21.79889, @108.8702], @[@21.59888, @108.7403],
        @[@21.93562, @108.4692], @[@21.59014, @108.5125], @[@21.68999, @108.3336], @[@21.51444, @108.2447], @[@21.54241, @107.99],
        @[@21.66694, @107.7831], @[@21.60526, @107.3627], @[@22.03083, @106.6933], @[@22.45682, @106.5517], @[@22.76389, @106.7875],
        @[@22.86694, @106.7029], @[@22.91253, @105.8771], @[@23.32416, @105.3587], @[@23.18027, @104.9075], @[@22.81805, @104.7319],
        @[@22.6875, @104.3747], @[@22.79812, @104.1113], @[@22.50387, @103.9687], @[@22.78287, @103.6538], @[@22.58436, @103.5224],
        @[@22.79451, @103.3337], @[@22.43652, @103.0304], @[@22.77187, @102.4744], @[@22.39629, @102.1407], @[@22.49777, @101.7415],
        @[@22.20916, @101.5744], @[@21.83444, @101.7653], @[@21.14451, @101.786], @[@21.17687, @101.2919], @[@21.57264, @101.1482],
        @[@21.76903, @101.099], @[@21.47694, @100.6397], @[@21.43546, @100.2057], @[@21.72555, @99.97763], @[@22.05018, @99.95741],
        @[@22.15592, @99.16785], @[@22.93659, @99.56484], @[@23.08204, @99.5113], @[@23.18916, @98.92747], @[@23.97076, @98.67991],
        @[@24.16007, @98.89073], @[@23.92999, @97.54762], @[@24.26055, @97.7593], @[@24.47666, @97.54305], @[@24.73992, @97.55255],
        @[@25.61527, @98.19109], @[@25.56944, @98.36137], @[@25.85597, @98.7104], @[@26.12527, @98.56944], @[@26.18472, @98.73109],
        @[@26.79166, @98.77777], @[@27.52972, @98.69699], @[@27.6725, @98.45888], @[@27.54014, @98.31992], @[@28.14889, @98.14499],
        @[@28.54652, @97.55887], @[@28.22277, @97.34888], @[@28.46749, @96.65387], @[@28.35111, @96.40193], @[@28.525, @96.34027],
        @[@28.79569, @96.61373], @[@29.05666, @96.47083], @[@28.90138, @96.17532], @[@29.05972, @96.14888], @[@29.25757, @96.39172],
        @[@29.46444, @96.08315], @[@29.03527, @95.38777], @[@29.33346, @94.64751], @[@29.07348, @94.23456], @[@28.6692, @93.96172],
        @[@28.61876, @93.35194], @[@28.3193, @93.22205], @[@28.1419, @92.71044], @[@27.86194, @92.54498], @[@27.76472, @91.65776],
        @[@27.945, @91.66277], @[@28.08111, @91.30138], @[@27.96999, @91.08693], @[@28.07958, @90.3765], @[@28.24257, @90.38898],
        @[@28.32369, @89.99819], @[@28.05777, @89.48749], @[@27.32083, @88.91693]
    ]];
    
    [list addObject:@[     //台湾
        @[@25.13474, @121.4441],
        @[@25.28361, @121.5632],
        @[@25.00722, @122.0004],
        @[@24.85028, @121.8182],
        @[@24.47638, @121.8397],
        @[@23.0875, @121.3556],
        @[@21.92791, @120.7196],
        @[@22.31277, @120.6103],
        @[@22.54044, @120.3071],
        @[@23.04437, @120.0539],
        @[@23.61708, @120.1112],
        @[@25.00166, @121.0017],
        @[@25.13474, @121.4441]
    ]];
    
    [list addObject:@[  //海南
        @[@19.52888, @110.855],
        @[@19.16761, @110.4832],
        @[@18.80083, @110.5255],
        @[@18.3852, @110.0503],
        @[@18.39152, @109.7594],
        @[@18.19777, @109.7036],
        @[@18.50562, @108.6871],
        @[@19.28028, @108.6283],
        @[@19.76, @109.2939],
        @[@19.7236, @109.1653],
        @[@19.89972, @109.2572],
        @[@19.82861, @109.4658],
        @[@19.99389, @109.6108],
        @[@20.13361, @110.6655],
        @[@19.97861, @110.9425],
        @[@19.63829, @111.0215],
        @[@19.52888, @110.855]
    ]];
    
    [list addObject:@[  //崇明岛
        @[@31.80054, @121.2039],
        @[@31.49972, @121.8736],
        @[@31.53111, @121.5464],
        @[@31.80054, @121.2039]
    ]];
    
    [list addObject:@[  //沿海和海洋区域
        @[@22.141038, @107.877984],
        @[@21.539845, @108.025162],
        @[@21.290034, @107.90558 ],
        @[@20.025918, @107.418052],
        @[@19.189033, @107.344462],
        @[@17.678896, @108.006765],
        @[@16.404594, @109.000219],
        @[@15.300443, @109.846495],
        @[@13.795116, @110.177646],
        @[@13.038678, @110.214441],
        @[@10.937653, @109.993673],
        @[@7.978664 , @108.4483  ],
        @[@6.435266 , @108.337916],
        @[@5.661708 , @108.595479],
        @[@4.517912 , @109.441754],
        @[@3.520193 , @110.913538],
        @[@3.409263 , @111.870197],
        @[@3.742013 , @112.826857],
        @[@4.813279 , @114.004284],
        @[@5.219195 , @114.188257],
        @[@7.317863 , @115.696835],
        @[@9.808284 , @117.462976],
        @[@13.038678, @119.118732],
        @[@16.794893, @119.118732],
        @[@18.663771, @119.854624],
        @[@19.956347, @120.516927],
        @[@21.410686, @121.731149],
        @[@23.768129, @122.94537 ],
        @[@25.316381, @123.497289],
        @[@27.207372, @125.153046],
        @[@29.646722, @126.698419],
        @[@30.924056, @127.066365],
        @[@32.527952, @125.741759],
        @[@34.042211, @125.079457],
        @[@35.379128, @125.116251],
        @[@36.694062, @124.821894],
        @[@38.015813, @124.233181],
        @[@38.855116, @124.012413],
        @[@38.595696, @122.46704 ],
        @[@39.54225 , @124.30677 ],
        @[@39.929322, @124.338965],
        @[@40.0284  , @124.398757],
        @[@40.067283, @124.407955],
        @[@40.166159, @124.467746],
        @[@40.204963, @124.495342],
        @[@40.472454, @124.476945],
        @[@40.416229, @124.122797],
        @[@40.899611, @123.308717],
        @[@41.676704, @122.168084],
        @[@41.566262, @121.211425],
        @[@40.703882, @119.114133],
        @[@39.702316, @117.458376],
        @[@39.274645, @116.961649],
        @[@38.829936, @116.556909],
        @[@38.121264, @117.219212],
        @[@37.800804, @117.550363],
        @[@37.023011, @118.433433],
        @[@35.57853 , @118.635803],
        @[@33.723808, @117.826322],
        @[@32.141353, @117.918309],
        @[@30.43507 , @118.948557],
        @[@30.43507 , @118.948557],
        @[@28.76296 , @120.08919 ],
        @[@28.76296 , @120.08919 ],
        @[@26.220142, @118.157474],
        @[@24.952105, @117.182417],
        @[@23.924664, @115.361085],
        @[@23.602926, @114.036479],
        @[@23.416291, @112.527901],
        @[@22.974095, @111.313679],
        @[@22.427841, @109.694717],
        @[@22.359405, @107.983769],
        @[@22.141038, @107.877984],       //需要闭合第一个点
    ]];
    
    _regionOfChinaArray = list;
    return _regionOfChinaArray;
}

- (BOOL)isInsideChina:(double)latitude longitude:(double)longitude
{
    BOOL inside = false;
    for (int i=0; i<self.regionOfChinaArray.count; i++) {
        NSArray *list = self.regionOfChinaArray[i];
        NSArray *prePoint = list[0];
        double preLatitude = [prePoint[0] floatValue];
        double preLongitude = [prePoint[1] floatValue];
        double nextLatitude = 0;
        double nextLongitude = 0;
        
        for (int j = 1; j < list.count; j++) {
            NSArray *nextPoint = list[j];
            nextLatitude = [nextPoint[0] floatValue];
            nextLongitude = [nextPoint[1] floatValue];
            
            if (longitude > MIN(preLongitude, nextLongitude) && longitude <= MAX(preLongitude, nextLongitude)
                && latitude <= MAX(preLatitude, nextLatitude) && preLongitude != nextLongitude) {
                double xinters = (longitude - preLongitude) * (nextLatitude - preLatitude) / (nextLongitude - preLongitude) + preLatitude;
                if (preLatitude == nextLatitude || latitude <= xinters) {
                    inside ^= true;
                }
            }
            preLatitude = nextLatitude;
            preLongitude = nextLongitude;
        }
        if (inside) {
            return inside;
        }
    }
    return inside;
}

- (void)clearCheckStatus {
    self.checkCount = 0;
    self.checkStatus = NO;
    self.isCloseCheckStatus = NO;
}

- (void)closeCheckStatus {
    self.isCloseCheckStatus = YES;
}

#pragma mark -

#define PI M_PI
#define X_PI (M_PI * 3000.0 / 180.0)
#define AXIS 6378245.0
#define OFFSET 0.00669342162296594323

+ (double)transformLat:(double) x y:(double)y {
    double ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * sqrt(fabs(x));
    ret += (20.0 * sin(6.0 * x * PI) + 20.0 * sin(2.0 * x * PI)) * 2.0 / 3.0;
    ret += (20.0 * sin(y * PI) + 40.0 * sin(y / 3.0 * PI)) * 2.0 / 3.0;
    ret += (160.0 * sin(y / 12.0 * PI) + 320 * sin(y * PI / 30.0)) * 2.0 / 3.0;
    return ret;
}

+ (double)transformLon:(double) x y:(double)y {
    double ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * sqrt(fabs(x));
    ret += (20.0 * sin(6.0 * x * PI) + 20.0 * sin(2.0 * x * PI)) * 2.0 / 3.0;
    ret += (20.0 * sin(x * PI) + 40.0 * sin(x / 3.0 * PI)) * 2.0 / 3.0;
    ret += (150.0 * sin(x / 12.0 * PI) + 300.0 * sin(x / 30.0 * PI)) * 2.0 / 3.0;
    return ret;
}

+ (CLLocationCoordinate2D)delta:(double)lat lon:(double)lon {
    double dLat = [self transformLat:lon - 105.0 y:lat - 35.0];
    double dLon = [self transformLon:lon - 105.0 y:lat - 35.0];
    double radLat = lat / 180.0 * PI;
    double magic = sin(radLat);
    magic = 1 - OFFSET * magic * magic;
    double sqrtMagic = sqrt(magic);
    dLat = (dLat * 180.0) / ((AXIS * (1 - OFFSET)) / (magic * sqrtMagic) * PI);
    dLon = (dLon * 180.0) / (AXIS / sqrtMagic * cos(radLat) * PI);
    return CLLocationCoordinate2DMake(dLat, dLon);
}

#pragma mark -

+ (BOOL)outOfChina:(double)lat lon:(double)lon {
    if (![ZJGpsUtils shared].isCloseCheckStatus && [ZJGpsUtils shared].checkCount > 5) {  //仅连续检测5次
        return ![ZJGpsUtils shared].checkStatus;   //这里记得要取反
    }
    
    BOOL ret = [[ZJGpsUtils shared] isInsideChina:lat longitude:lon];
    if (ret != [ZJGpsUtils shared].checkStatus) {
        [ZJGpsUtils shared].checkCount = 0;
    }
    [ZJGpsUtils shared].checkCount ++;
    [ZJGpsUtils shared].checkStatus = ret;
    
    return !ret;
}

+ (CGFloat)distance:(CLLocationCoordinate2D)latLngA latLngB:(CLLocationCoordinate2D)latLngB {
    int earthR = 6371000;
    double x = cos(latLngA.latitude*PI/180) * cos(latLngB.latitude*PI/180) * cos((latLngA.longitude-latLngB.longitude)*PI/180);
    double y = sin(latLngA.latitude*PI/180) * sin(latLngA.latitude*PI/180);
    double s = x + y;
    if (s > 1)
        s = 1;
    if (s < -1)
        s = -1;
    double alpha = acos(s);
    double distance = alpha * earthR;
    return distance;
}

#pragma mark -

+ (CLLocationCoordinate2D)wgs84_To_BD09ll:(CLLocationCoordinate2D)latLng {
    if ([self outOfChina:latLng.latitude lon:latLng.longitude]) {
        return latLng;
    }
    CLLocationCoordinate2D t = [self wgs84_To_GCJ02:latLng];
    return [self gcj02_To_BD09ll:t];
}

+ (CLLocationCoordinate2D)wgs84_To_GCJ02:(CLLocationCoordinate2D)latLng {
    if ([self outOfChina:latLng.latitude lon:latLng.longitude]) {
        return latLng;
    }
    CLLocationCoordinate2D t = [self delta:latLng.latitude lon:latLng.longitude];
    double latitude = latLng.latitude + t.latitude;
    double longitude = latLng.longitude + t.longitude;
    return CLLocationCoordinate2DMake(latitude, longitude);
}

+ (CLLocationCoordinate2D)gcj02_To_BD09ll:(CLLocationCoordinate2D)latLng {
    double x = latLng.longitude;
    double y = latLng.latitude;
    double z = sqrt(x * x + y * y) + 0.00002 * sin(y * X_PI);
    double theta = atan2(y, x) + 0.000003 * cos(x * X_PI);
    double latitude = z * sin(theta) + 0.006;
    double longitude = z * cos(theta) + 0.0065;
    return CLLocationCoordinate2DMake(latitude, longitude);
}

+ (CLLocationCoordinate2D)gcj02_To_WGS84:(CLLocationCoordinate2D)latLng {
//    if ([self outOfChina:latLng.latitude lon:latLng.longitude]) {
//        return latLng;
//    }
    CLLocationCoordinate2D t = [self delta:latLng.latitude lon:latLng.longitude];
    double latitude = latLng.latitude - t.latitude;
    double longitude = latLng.longitude - t.longitude;
    return CLLocationCoordinate2DMake(latitude, longitude);
}

+ (CLLocationCoordinate2D)bd09ll_To_WGS84:(CLLocationCoordinate2D)latLng {
    CLLocationCoordinate2D t = [self bd09ll_To_GCJ02:latLng];
    return [self gcj02_To_WGS84:t];
}

+ (CLLocationCoordinate2D)bd09ll_To_GCJ02:(CLLocationCoordinate2D)latLng {
    double x = latLng.longitude - 0.0065;
    double y = latLng.latitude - 0.006;
    double z = sqrt(x * x + y * y) - 0.00002 * sin(y * X_PI);
    double theta = atan2(y, x) - 0.000003 * cos(x * X_PI);
    double latitude = z * sin(theta);
    double longitude = z * cos(theta);
    return CLLocationCoordinate2DMake(latitude, longitude);
}

+ (CLLocationCoordinate2D)gcj02_To_WGS84_Exactly:(CLLocationCoordinate2D)latLng {
    double gcjLat = latLng.latitude;
    double gcjLon = latLng.longitude;
    
    double initDelta = 0.01;
    double threshold = 0.000000001;
    double dLat = initDelta, dLon = initDelta;
    double mLat = gcjLat - dLat, mLon = gcjLon - dLon;
    double pLat = gcjLat + dLat, pLon = gcjLon + dLon;
    double wgsLat, wgsLon, i = 0;
    while (true) {
        wgsLat = (mLat + pLat) / 2;
        wgsLon = (mLon + pLon) / 2;
        CLLocationCoordinate2D t = [self wgs84_To_GCJ02:CLLocationCoordinate2DMake(wgsLat, wgsLon)];
        dLat = t.latitude - gcjLat;
        dLon = t.longitude - gcjLon;
        if ((fabs(dLat) < threshold) && (fabs(dLon) < threshold))
            break;
        
        if (dLat > 0) pLat = wgsLat; else mLat = wgsLat;
        if (dLon > 0) pLon = wgsLon; else mLon = wgsLon;
        
        if (++i > 10000) break;
    }
    return CLLocationCoordinate2DMake(wgsLat, wgsLon);
}

@end
